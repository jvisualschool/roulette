<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5899C1DJM0"></script>

  <title>Marble Roulette</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" sizes="57x57" href="assets/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="assets/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="assets/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="assets/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="assets/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="assets/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="assets/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="assets/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="assets/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="manifest" href="assets/manifest.json">

  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="assets/ms-icon-144x144.png">
  <meta name="theme-color" content="#0d0d12">

  <meta name="description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:url" content="https://lazygyu.github.io/roulette/">
  <meta property="og:title" content="Marble Roulette">
  <meta property="og:description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:site_name" content="lazygyu.github.io">
  <meta property="og:type" content="website">

  <link rel='stylesheet' href='assets/style.scss' />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>

<body class="dark"> <!-- 기본 테마를 다크로 설정 -->
  <script type="module" src="./src/index.ts"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-5899C1DJM0');

    function getNames() {
      const value = document.querySelector('#in_names').value.trim();
      return value.split(/[,\r\n]/g).map(v => v.trim()).filter(v => !!v);
    }

    function parseName(nameStr) {
      const weightRegex = /(\/\d+)/;
      const countRegex = /(\*\d+)/;
      const hasWeight = weightRegex.test(nameStr);
      const hasCount = countRegex.test(nameStr);
      const name = /^\s*([^\/*]+)?/.exec(nameStr)[1];
      const weight = hasWeight ? parseInt(weightRegex.exec(nameStr)[1].replace('/', '')) : 1;
      const count = hasCount ? parseInt(countRegex.exec(nameStr)[1].replace('*', '')) : 1;
      return {
        name,
        weight,
        count,
      };
    }

    function getReady() {
      const names = getNames();
      window.roulette.setMarbles(names);
      ready = names.length > 0;
      localStorage.setItem('mbr_names', names.join(','));
      switch (winnerType) {
        case 'first':
          setWinnerRank(1);
          break;
        case 'last':
          const total = window.roulette.getCount();
          setWinnerRank(total);
          break;
      }
    }

    function setWinnerRank(rank) {
      document.querySelector('#in_winningRank').value = rank;
      window.options.winningRank = rank - 1;
      window.roulette.setWinningRank(window.options.winningRank);

      if (winnerType === 'first') {
        document.querySelector('.btn-first-winner').classList.toggle('active', true);
        document.querySelector('.btn-last-winner').classList.toggle('active', false);
        document.querySelector('#in_winningRank').classList.toggle('active', false);
      } else if (winnerType === 'last') {
        document.querySelector('.btn-first-winner').classList.toggle('active', false);
        document.querySelector('.btn-last-winner').classList.toggle('active', true);
        document.querySelector('#in_winningRank').classList.toggle('active', false);
      } else if (winnerType === 'custom') {
        document.querySelector('.btn-first-winner').classList.toggle('active', false);
        document.querySelector('.btn-last-winner').classList.toggle('active', false);
        document.querySelector('#in_winningRank').classList.toggle('active', true);
      }
    }


    let ready = false;
    let winnerType = 'first';

    document.addEventListener('DOMContentLoaded', () => {
      initialize();
    });

    function initialize() {
      if (!window.roulette || !window.roulette.isReady) {
        setTimeout(initialize, 50);
        return;
      }
      console.log('initializing start');

      const urlParams = new URLSearchParams(window.location.search);
      const namesFromUrl = urlParams.get('names');

      if (namesFromUrl) {
        document.querySelector('#in_names').value = namesFromUrl.replace(/,/g, '\n');
      }
      // localStorage에서 이전 이름을 불러오는 기능 비활성화 (기본값 유지)
      // else {
      //   const savedNames = localStorage.getItem('mbr_names');
      //   if (savedNames) {
      //     document.querySelector('#in_names').value = savedNames;
      //   }
      // }
      document.querySelector('#in_names').addEventListener('input', () => {
        getReady();
      });

      document.querySelector('#in_names').addEventListener('blur', () => {
        const nameSource = getNames();
        const nameSet = new Set();
        const nameCounts = {};
        nameSource.forEach(nameSrc => {
          const name = parseName(nameSrc);
          const key = name.weight > 1 ? `${name.name}/${name.weight}` : name.name;
          if (!nameSet.has(key)) {
            nameSet.add(key);
            nameCounts[key] = 0;
          }
          nameCounts[key] += name.count;
        });
        const result = [];
        Object.keys(nameCounts).forEach(key => {
          if (nameCounts[key] > 1) {
            result.push(`${key}*${nameCounts[key]}`);
          } else {
            result.push(key);
          }
        });

        const oldValue = document.querySelector('#in_names').value;
        const newValue = result.join(',');

        if (oldValue !== newValue) {
          document.querySelector('#in_names').value = newValue;
          getReady();
        }
      });

      document.querySelector('#btnShuffle').addEventListener('click', () => {
        getReady();
      });

      document.querySelector('#btnStart').addEventListener('click', () => {
        if (!ready) return;
        gtag && gtag('event', 'start', {
          'event_category': 'roulette',
          'event_label': 'start',
          'value': window.roulette.getCount(),
        });
        gsap.to('#settings', {
          y: 40,
          opacity: 0,
          duration: 0.6,
          ease: 'power3.in',
          onComplete: () => {
            document.querySelector('#settings').classList.add('hide');
            window.roulette.start();
          }
        });
      });

      document.querySelector('#chkAutoRecording').addEventListener('change', (e) => {
        window.options.autoRecording = e.target.matches(':checked');
        window.roulette.setAutoRecording(window.options.autoRecording);
      });

      document.querySelector('#chkSkill').addEventListener('change', (e) => {
        window.options.useSkills = e.target.matches(':checked');
        window.roulette.setWinningRank(window.options.winningRank);
      });

      document.querySelector('#chkDarkMode').addEventListener('change', (e) => {
        window.options.darkMode = e.target.matches(':checked');
        window.roulette.setTheme(window.options.darkMode ? 'dark' : 'light');
        document.documentElement.classList.toggle('light', !window.options.darkMode);
      });

      document.querySelector('#in_winningRank').addEventListener('change', (e) => {
        const v = parseInt(e.target.value, 10);
        winnerType = 'custom';
        setWinnerRank(isNaN(v) ? 0 : v);
      });

      document.querySelector('.btn-last-winner').addEventListener('click', () => {
        const total = window.roulette.getCount();
        winnerType = 'last';
        setWinnerRank(total);
      });
      document.querySelector('.btn-first-winner').addEventListener('click', () => {
        winnerType = 'first';
        setWinnerRank(1);
      });

      window.roulette.addEventListener('goal', () => {
        ready = false;
        setTimeout(() => {
          const settings = document.querySelector('#settings');
          settings.classList.remove('hide');
          gsap.fromTo(settings,
            { y: 40, opacity: 0 },
            { y: 0, opacity: 1, duration: 0.8, ease: 'power3.out' }
          );
        }, 3000);
      });

      window.roulette.addEventListener('message', (e) => {
        simpleToast(e.detail);
      });

      document.querySelector('#btnShuffle').click();

      const maps = window.roulette.getMaps();
      const mapSelector = document.querySelector('#sltMap');
      maps.forEach((map) => {
        const option = document.createElement('option');
        option.value = map.index;
        option.innerHTML = map.title;
        option.setAttribute('data-trans', '');
        window.translateElement(option);
        mapSelector.append(option);
      });
      mapSelector.addEventListener('change', (e) => {
        const index = e.target.value;
        window.roulette.setMap(index);
      });

      mapSelector.addEventListener('change', (e) => {
        const index = e.target.value;
        window.roulette.setMap(index);
      });

      function simpleToast(msg) {
        const toast = document.createElement('div');
        toast.classList.add('toast');
        toast.innerHTML = msg;

        if (window.translateElement) {
          console.log('try to translate');
          window.translateElement(toast);
        }

        document.body.appendChild(toast);
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 1200);
      }

      // 초기 등장 애니메이션
      gsap.from("#settings", {
        y: 100,
        opacity: 0,
        duration: 1.2,
        ease: "expo.out",
        delay: 0.5
      });

      gsap.from(".controls > *", {
        y: 20,
        opacity: 0,
        stagger: 0.08,
        duration: 0.8,
        ease: "power3.out",
        delay: 0.8
      });
    }
  </script>
  <div id="settings" class="settings">
    <div class="controls">
      <!-- Arena Map -->
      <div class="row inline-row">
        <label for='sltMap'>
          <i class="icon map"></i>
          <span data-trans>Arena Map</span>
        </label>
        <select id="sltMap"></select>
      </div>

      <!-- Winner Selection -->
      <div class="row inline-row">
        <label>
          <i class="icon trophy"></i>
          <span data-trans>The winner is</span>
        </label>
        <div class="btn-group">
          <button type="button" class="btn-winner btn-first-winner active" data-trans>First</button>
          <button type="button" class="btn-winner btn-last-winner" data-trans>Last</button>
          <input type="number" id="in_winningRank" value="1" min="1" />
        </div>
      </div>

      <!-- Toggles -->
      <div class="row toggle-row">
        <div class="toggle-item">
          <label for='chkAutoRecording'>
            <i class="icon record"></i>
            <span data-trans>Recording</span>
          </label>
          <input type="checkbox" id="chkAutoRecording" />
        </div>

        <div class="toggle-item">
          <label for='chkSkill'>
            <i class="icon bomb"></i>
            <span data-trans>Skills</span>
          </label>
          <input type="checkbox" id="chkSkill" checked />
        </div>

        <div class="toggle-item theme-toggle">
          <i class='icon sun'></i>
          <input type='checkbox' id='chkDarkMode' checked />
          <i class='icon moon'></i>
        </div>
      </div>

      <!-- Name Input -->
      <div class="name-section">
        <h3 data-trans><span class="dot-trigger" id="infoTrigger"></span>Enter names below</h3>
        <textarea id="in_names" placeholder="Input names separated by commas or line feed here"
          data-trans="placeholder">둘리, 또치, 도우너, 희동이, 고길동, 마이콜, 영희, 철수, 박정자, 김수정, 하니, 홍두깨</textarea>
      </div>

      <!-- Action Buttons -->
      <div class="actions">
        <button id="btnShuffle">
          <i class="icon shuffle"></i>
          <span data-trans>Shuffle</span>
        </button>
        <button id="btnStart">
          <i class="icon play"></i>
          <span data-trans>Start Game</span>
        </button>
      </div>
    </div>
  </div>
  <div class="copyright">
    <div>&copy; 2022-2026. <a href="https://lazygyu.net" target="_blank">lazygyu</a> 이 프로그램은 프리웨어이며 방송이나 영상 등을 포함한</div>
    <div>어떤 용도로든 자유롭게 사용하는 것이 허용되어있습니다.</div>
  </div>

  <!-- Splash / Info Modal -->
  <div id="infoModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="image-container-16-9">
          <img src="splash.jpg" alt="Marble Roulette Splash">
        </div>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <h1>Marble Roulette</h1>
        <div class="info-grid">
          <div class="info-item">
            <label>Original Creator</label>
            <p><a href="https://lazygyu.net" target="_blank">lazygyu</a></p>
          </div>
          <div class="info-item">
            <label>Original Source</label>
            <p><a href="https://github.com/lazygyu/roulette" target="_blank">GitHub Repository</a></p>
          </div>
          <div class="info-item">
            <label>UI/UX Design</label>
            <p><a href="mailto:jvisualschool@gmail.com">Jinho Jung</a></p>
          </div>
          <div class="info-item">
            <label>Tech Stack</label>
            <p>
              <a href="https://www.typescriptlang.org/" target="_blank">TypeScript</a>,
              <a href="https://box2d.org/" target="_blank">Box2D</a>,
              <a href="https://parceljs.org/" target="_blank">Parcel</a>,
              <a href="https://greensock.com/gsap/" target="_blank">GSAP</a>
            </p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // Info Modal Logic
    const infoTrigger = document.getElementById('infoTrigger');
    const infoModal = document.getElementById('infoModal');
    const closeBtn = document.querySelector('.modal-close');

    infoTrigger.addEventListener('click', () => {
      infoModal.classList.add('show');
      gsap.fromTo(".modal-content",
        { scale: 0.8, opacity: 0, y: 20 },
        { scale: 1, opacity: 1, y: 0, duration: 0.5, ease: "back.out(1.7)" }
      );
    });

    const closeModal = () => {
      gsap.to(".modal-content", {
        scale: 0.8, opacity: 0, y: 20, duration: 0.3, ease: "power2.in",
        onComplete: () => infoModal.classList.remove('show')
      });
    };

    closeBtn.addEventListener('click', closeModal);
    infoModal.addEventListener('click', (e) => {
      if (e.target === infoModal) closeModal();
    });
  </script>
</body>

</html>